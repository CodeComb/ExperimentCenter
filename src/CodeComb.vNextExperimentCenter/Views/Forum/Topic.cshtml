@model IEnumerable<Post>
@{ 
    Topic Topic = ViewBag.Topic;
    ViewBag.Title = Topic.Title;
}

<div class="container">
    <div class="cont-wrap">
        <div class="grid_12">
            <h2 class="forum-title">@ViewBag.Title</h2>
            <div class="cont-outer">
                <div class="table-post-outer">
                    <table class="table-post">
                        <colgroup>
                            <col style="width: 160px;" />
                            <col />
                        </colgroup>
                        <thead>
                            <tr>
                                <th class="center table-post-info">查看: @Topic.Visit | 回复: @ViewBag.PagerInfo.Count</th>
                                <th>@Topic.Title</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="center">
                                    <a asp-action="Show" asp-controller="Account" asp-route-id="@Topic.UserId" class="center">@await Html.ColorUserNameAsync(Topic.User)</a>
                                    <hr />
                                    <p><img class="post-avatar" src="@Url.Action("Avatar", "Account", new { id = Topic.UserId })" /></p>
                                    <p class="post-role"><span class="topic-label purple">@((await User.Manager.GetRolesAsync(Topic.User)).First())</span></p>
                                </td>
                                <td>
                                    @if (Topic.IsAnnouncement)
                                    {
                                        <span class="topic-label purple">ANNOUNCEMENT</span>
                                    }
                                    @if (Topic.IsTop)
                                    {
                                        <span class="topic-label purple">TOP</span>
                                    }
                                    @if (User.IsSignedIn())
                                    {
                                        <a>回复</a>
                                        @if (Topic.UserId == User.Current.Id || User.AnyRoles("Root, Master"))
                                        {
                                            <a>编辑</a>
                                            <a>删除</a>
                                        }
                                        @if (User.AnyRoles("Root, Master"))
                                        {
                                            <a>置顶/取消置顶</a>
                                            <a>设置/取消公告</a>
                                        }
                                    }
                                    <span class="table-post-time">发表于 @Topic.CreationTime.ToString("yyyy-MM-dd HH:mm:ss")</span>
                                    <hr />
                                    @Html.Sanitize(Html.Marked(Topic.Content).ToString())
                                </td>
                            </tr>
                            @foreach (var x in Model)
                            {
                                <tr>
                                    <td class="center">
                                        <a asp-action="Show" asp-controller="Account" asp-route-id="@Topic.UserId" class="center">@await Html.ColorUserNameAsync(Topic.User)</a>
                                        <hr />
                                        <p><img class="post-avatar" src="@Url.Action("Avatar", "Account", new { id = Topic.UserId })" /></p>
                                        <p class="post-role"><span class="topic-label purple">@((await User.Manager.GetRolesAsync(Topic.User)).First())</span></p>
                                    </td>
                                    <td>
                                        @if (Topic.UserId == x.UserId)
                                        {
                                            <span class="topic-label">楼主</span>
                                        }
                                        @if (User.IsSignedIn())
                                        {
                                            <a>回复</a>
                                            @if (x.UserId == User.Current.Id || User.AnyRoles("Root, Master"))
                                            {
                                                <a>编辑</a>
                                                <a>删除</a>
                                            }
                                        }
                                        <span class="table-post-time">回复于 @x.Time.ToString("yyyy-MM-dd HH:mm:ss")</span>
                                        <hr />
                                        @Html.Sanitize(Html.Marked(x.Content).ToString())
                                        @if (x.SubPosts.Count > 0)
                                        {
                                            <h3 class="comment-header">楼中回复</h3>
                                            foreach (var y in x.SubPosts.OrderBy(z => z.Time))
                                            {
                                                <div class="comment-item">
                                                    <img class="comment-avatar" src="@Url.Action("Avatar", "Account", new { id = Topic.UserId })" />
                                                    <div class="comment-content">
                                                        <p>
                                                            @if ((await User.Manager.GetRolesAsync(y.User)).First() == "Root" || (await User.Manager.GetRolesAsync(y.User)).First() == "Master")
                                                            {
                                                                <span class="topic-label purple">@((await User.Manager.GetRolesAsync(y.User)).First())</span>
                                                            }
                                                            else if (y.UserId == Topic.UserId)
                                                            {
                                                                <span class="topic-label">楼主</span>
                                                            }
                                                            <a asp-action="Show" asp-controller="Account" asp-route-id="@x.UserId" class="center">@await Html.ColorUserNameAsync(y.User)</a>
                                                            <span class="table-post-time">@@@x.Time.ToString("yyyy-MM-dd HH:mm:ss")</span>
                                                        </p>
                                                        @Html.Sanitize(Html.Marked(y.Content).ToString())
                                                    </div>
                                                    <div class="clear"></div>
                                                </div>
                                            }
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
                <br />
                <div class="pager-outer">
                    @Html.MakePager()
                    <div class="clear"></div>
                </div>
                @if (User.IsSignedIn() && (!Topic.IsLocked || User.AnyRoles("Root, Master")))
                {
                    <br />
                    <table class="table-post table-post-outer">
                        <colgroup>
                            <col style="width: 160px;" />
                            <col />
                        </colgroup>
                        <tr>
                            <td></td>
                            <td>
                                <p>发表回复</p>
                                <form asp-action="Post" asp-controller="Forum" asp-route-id="@Topic.Id" method="post">
                                    <div class="markdown-editor-outer">
                                        <textarea class="textbox markdown-editor" name="Content"></textarea>
                                        <div class="markdown-editor-bottom">支持Markdown语法、拖拽图片文件至编辑区或直接从剪贴板粘贴可上传图片文件。</div>
                                    </div>
                                    <hr />
                                    <p>
                                        <input type="submit" class="btn btn-default" value="回复" />
                                    </p>
                                </form>
                            </td>
                        </tr>
                    </table>
                }
            </div>
        </div>
    </div>
</div>
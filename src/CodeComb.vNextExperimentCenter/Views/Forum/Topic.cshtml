@model IEnumerable<Post>
@{
    Topic Topic = ViewBag.Topic;
    ViewBag.Title = Topic.Title;
}

<div class="hidden" id="new-post-outer">
    <div id="new-post" class="new-comment">
        <p>发表回复</p>
        <form asp-action="Post" asp-controller="Forum" asp-route-id="@Topic.Id" id="frmNewPost">
            <input type="hidden" name="pid" id="new-post-pid" />
            <div class="markdown-editor-outer">
                <textarea class="textbox markdown-editor" name="Content"></textarea>
                <div class="markdown-editor-bottom">
                    <a href="javascript:$('#frmNewPost').submit()">发表回复</a>
                    <a href="javascript:$('#new-post-outer').append($('#new-post'))">取消回复</a>
                    支持Markdown语法、拖拽图片文件至编辑区或直接从剪贴板粘贴可上传图片文件。
                </div>
            </div>
        </form>
    </div>
</div>

<div class="container">
    <div class="cont-wrap">
        <div class="grid_12">
            <h2 class="forum-title">@ViewBag.Title</h2>
            <div class="cont-outer">
                <div class="table-post-outer">
                    <table class="table-post">
                        <colgroup>
                            <col style="width: 160px;" />
                            <col />
                        </colgroup>
                        <thead>
                            <tr>
                                <th class="center table-post-info">查看: @Topic.Visit | 回复: @ViewBag.Count</th>
                                <th>@Topic.Title</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="center">
                                    <a asp-action="Show" asp-controller="Account" asp-route-id="@Topic.UserId" class="center">@await Html.ColorUserNameAsync(Topic.User)</a>
                                    <hr />
                                    <p><img class="post-avatar" src="@Url.Action("Avatar", "Account", new { id = Topic.UserId })" /></p>
                                    <p class="post-role"><span class="topic-label purple">@((await User.Manager.GetRolesAsync(Topic.User)).First())</span></p>
                                </td>
                                <td>
                                    @if (Topic.IsAnnouncement)
                                    {
                                        <span class="topic-label purple">ANNOUNCEMENT</span>
                                    }
                                    @if (Topic.IsTop)
                                    {
                                        <span class="topic-label purple">TOP</span>
                                    }
                                    @if (User.IsSignedIn())
                                    {
                                        @if (Topic.UserId == User.Current.Id || User.AnyRoles("Root, Master"))
                                        {
                                            <a>编辑</a>
                                            <a>删除</a>
                                        }
                                        @if (User.AnyRoles("Root, Master"))
                                        {
                                            <a href="javascript:Top()">置顶/取消置顶</a>
                                            <a href="javascript:Notice()">设置/取消公告</a>
                                            <a href="javascript:Lock()">锁定/解锁</a>
                                        }
                                    }
                                    <span class="table-post-time">发表于 @Topic.CreationTime.ToString("yyyy-MM-dd HH:mm:ss")</span>
                                    <hr />
                                    @Html.Sanitize(Html.Marked(Topic.Content).ToString())
                                </td>
                            </tr>
                            @foreach (var x in Model)
                            {
                                <tr data-id="@x.Id">
                                    <td class="center">
                                        <a asp-action="Show" asp-controller="Account" asp-route-id="@Topic.UserId" class="center">@await Html.ColorUserNameAsync(Topic.User)</a>
                                        <hr />
                                        <p><img class="post-avatar" src="@Url.Action("Avatar", "Account", new { id = Topic.UserId })" /></p>
                                        <p class="post-role"><span class="topic-label purple">@((await User.Manager.GetRolesAsync(Topic.User)).First())</span></p>
                                    </td>
                                    <td>
                                        @if (Topic.UserId == x.UserId)
                                        {
                                            <span class="topic-label">楼主</span>
                                        }
                                        @if (User.IsSignedIn())
                                        {
                                            @if (User.IsSignedIn() && (!Topic.IsLocked || User.AnyRoles("Root, Master")) && x.SubPosts.Count == 0)
                                            {
                                                <a href="javascript:Post('@x.Id')">回复</a>
                                            }
                                            @if (x.UserId == User.Current.Id || User.AnyRoles("Root, Master"))
                                            {
                                                <a>编辑</a>
                                                <a href="javascript:RemovePost('@x.Id')">删除</a>
                                            }
                                        }
                                        <span class="table-post-time">回复于 @x.Time.ToString("yyyy-MM-dd HH:mm:ss")</span>
                                        <hr />
                                        @Html.Sanitize(Html.Marked(x.Content).ToString())
                                        @if (x.SubPosts.Count > 0)
                                        {
                                            <h3 class="comment-header">
                                                楼中楼回复
                                                @if (User.IsSignedIn() && (!Topic.IsLocked || User.AnyRoles("Root, Master")))
                                                {
                                                    <a href="javascript:Post('@x.Id')" class="add-comment">添加回复</a>
                                                }
                                            </h3>
                                            foreach (var y in x.SubPosts.OrderBy(z => z.Time))
                                            {
                                                <div class="comment-item" data-id="@y.Id">
                                                    <img class="comment-avatar" src="@Url.Action("Avatar", "Account", new { id = Topic.UserId })" />
                                                    <div class="comment-content">
                                                        <p>
                                                            @if ((await User.Manager.GetRolesAsync(y.User)).First() == "Root" || (await User.Manager.GetRolesAsync(y.User)).First() == "Master")
                                                            {
                                                                <span class="topic-label purple">@((await User.Manager.GetRolesAsync(y.User)).First())</span>
                                                            }
                                                            else if (y.UserId == Topic.UserId)
                                                            {
                                                                <span class="topic-label">楼主</span>
                                                            }
                                                            <a asp-action="Show" asp-controller="Account" asp-route-id="@x.UserId" class="center">@await Html.ColorUserNameAsync(y.User)</a>
                                                            <span class="table-post-time">@@@y.Time.ToString("yyyy-MM-dd HH:mm:ss")</span>
                                                            @if (User.IsSignedIn() && (y.UserId == User.Current.Id || User.AnyRoles("Root, Master")))
                                                            {
                                                                <a href="javascript:RemovePost('@y.Id')">删除</a>
                                                            }
                                                        </p>
                                                        @Html.Sanitize(Html.Marked(y.Content).ToString())
                                                    </div>
                                                    <div class="clear"></div>
                                                </div>
                                            }
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
                <br />
                <div class="pager-outer">
                    @Html.MakePager()
                    <div class="clear"></div>
                </div>
                @if (User.IsSignedIn() && (!Topic.IsLocked || User.AnyRoles("Root, Master")))
                {
                    <br />
                    <table class="table-post table-post-outer">
                        <colgroup>
                            <col style="width: 160px;" />
                            <col />
                        </colgroup>
                        <tr>
                            <td></td>
                            <td>
                                <p>发表回复</p>
                                <form asp-action="Post" asp-controller="Forum" asp-route-id="@Topic.Id" method="post">
                                    <div class="markdown-editor-outer">
                                        <textarea class="textbox markdown-editor" name="Content"></textarea>
                                        <div class="markdown-editor-bottom">支持Markdown语法、拖拽图片文件至编辑区或直接从剪贴板粘贴可上传图片文件。</div>
                                    </div>
                                    <hr />
                                    <p>
                                        <input type="submit" class="btn btn-default" value="回复" />
                                    </p>
                                </form>
                            </td>
                        </tr>
                    </table>
                }
            </div>
        </div>
    </div>
</div>
@if (User.AnyRoles("Root, Master"))
{
    <form asp-action="Top" asp-controller="Forum" asp-route-id="@Topic.Id" id="frmTop"></form>
    <form asp-action="Notice" asp-controller="Forum" asp-route-id="@Topic.Id" id="frmNotice"></form>
    <form asp-action="Lock" asp-controller="Forum" asp-route-id="@Topic.Id" id="frmLock"></form>
    <script>
        function Top() {
            $.post($('#frmTop').attr('action'), $('#frmTop').serialize(), function (result) { popResult(result); });
        }

        function Lock() {
            $.post($('#frmLock').attr('action'), $('#frmLock').serialize(), function (result) { popResult(result); });
        }

        function Notice() {
            $.post($('#frmNotice').attr('action'), $('#frmNotice').serialize(), function (result) { popResult(result); });
        }
    </script>
}
@if (User.IsSignedIn())
{
    <form asp-action="RemovePost" asp-controller="Forum" id="frmRemovePost">
        <input type="hidden" name="id" id="remove-post-id" />
    </form>
    <form asp-action="RemoveTopic" asp-controller="Forum" asp-route-id="@Topic.Id" id="frmRemoveTopic"></form>
    <script>
        function RemovePost(id) {
            $('#remove-post-id').val(id);
            popResult("正在删除回复...");
            $.post($('#frmRemovePost').attr('action'), $('#frmRemovePost').serialize(), function (result) { popResult(result); $('[data-id="' + id + '"]').remove(); });
        }

    function Post(pid)
    {
        $('#new-post-pid').val(pid);
        $('tr[data-id="' + pid + '"]').children('td').last().append($('#new-post'));
    }
    </script>
}